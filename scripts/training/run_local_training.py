#!/usr/bin/env python3
"""
üöÄ Run Local Training - Task 4.1
‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô PaddleOCR ‡πÅ‡∏ö‡∏ö local ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Thai OCR

Based on development-task.md Section 4.1:
- Local training: python PaddleOCR/tools/train.py -c configs/rec/thai_rec.yml
"""

import os
import sys
import subprocess
import logging
from pathlib import Path
from typing import Optional
import time
from datetime import datetime

# Setup logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class LocalTrainingRunner:
    """‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô PaddleOCR ‡πÅ‡∏ö‡∏ö local"""
    
    def __init__(self):
        self.project_root = Path.cwd()
        self.configs_dir = self.project_root / "configs" / "rec"
        self.paddleocr_dir = self.project_root / "PaddleOCR"
        self.train_script = self.paddleocr_dir / "tools" / "train.py"
        
    def check_prerequisites(self) -> bool:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô"""
        logger.info("üîç Checking prerequisites for local training...")
        
        issues = []
        
        # 1. Check PaddleOCR installation
        try:
            import paddle
            import paddleocr
            logger.info(f"  ‚úÖ PaddlePaddle version: {paddle.__version__}")
            logger.info(f"  ‚úÖ PaddleOCR installed")
        except ImportError as e:
            issues.append(f"Missing package: {e}")
        
        # 2. Check PaddleOCR repository
        if not self.paddleocr_dir.exists():
            issues.append("PaddleOCR repository not found. Run: git clone https://github.com/PaddlePaddle/PaddleOCR.git")
        elif not self.train_script.exists():
            issues.append(f"Training script not found: {self.train_script}")
        else:
            logger.info(f"  ‚úÖ PaddleOCR repository: {self.paddleocr_dir}")
        
        # 3. Check config files
        if not self.configs_dir.exists():
            issues.append("Configs directory not found. Run Task 3 first: python scripts/training/setup_training_config.py")
        else:
            configs = list(self.configs_dir.glob("thai_rec*.yml"))
            if configs:
                logger.info(f"  ‚úÖ Found {len(configs)} config files")
                for config in configs:
                    logger.info(f"    - {config.name}")
            else:
                issues.append("No Thai recognition configs found")
        
        # 4. Check GPU availability
        gpu_available = self._check_gpu()
        if gpu_available:
            logger.info("  ‚úÖ GPU available for training")
        else:
            logger.info("  ‚ö†Ô∏è No GPU detected - will use CPU (slower)")
        
        # 5. Check dataset
        dataset_valid = self._check_dataset()
        if dataset_valid:
            logger.info("  ‚úÖ Dataset validation passed")
        else:
            issues.append("Dataset validation failed")
        
        if issues:
            logger.error("‚ùå Prerequisites check failed:")
            for issue in issues:
                logger.error(f"  - {issue}")
            return False
        else:
            logger.info("‚úÖ All prerequisites satisfied!")
            return True
    
    def _check_gpu_system(self) -> bool:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPU availability ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ paddle)"""
        try:
            result = subprocess.run(["nvidia-smi"], capture_output=True, text=True)
            return result.returncode == 0
        except FileNotFoundError:
            return False
    
    def _check_gpu(self) -> bool:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPU availability"""
        try:
            import paddle
            gpu_count = paddle.device.cuda.device_count()
            return gpu_count > 0
        except:
            try:
                result = subprocess.run(["nvidia-smi"], capture_output=True, text=True)
                return result.returncode == 0
            except FileNotFoundError:
                return False
    
    def _check_dataset(self) -> bool:
        """‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö dataset"""
        # ‡∏´‡∏≤ dataset directory
        converted_dir = self.project_root / "thai-letters" / "datasets" / "converted"
        dataset_dirs = list(converted_dir.glob("train_data_thai_paddleocr_*"))
        
        if not dataset_dirs:
            logger.error("No converted datasets found")
            return False
        
        latest_dataset = max(dataset_dirs, key=os.path.getctime)
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        required_files = [
            "train_data/th_dict.txt",
            "train_data/rec/rec_gt_train.txt",
            "train_data/rec/rec_gt_val.txt",
            "train_data/rec/thai_data/train",
            "train_data/rec/thai_data/val"
        ]
        
        for file_path in required_files:
            full_path = latest_dataset / file_path
            if not full_path.exists():
                logger.error(f"Missing: {full_path}")
                return False
        
        logger.info(f"  üìÇ Dataset: {latest_dataset.name}")
        return True
    
    def setup_paddleocr(self, force_cpu: bool = False) -> bool:
        """‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° PaddleOCR"""
        logger.info("üì¶ Setting up PaddleOCR...")
        
        if force_cpu:
            paddle_package = "paddlepaddle"
            logger.info("üíª Force CPU installation requested")
        else:
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPU ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å package
            gpu_available = self._check_gpu_system()
            
            if gpu_available:
                paddle_package = "paddlepaddle-gpu"
                logger.info("üéÆ GPU detected - installing GPU version")
                logger.info("‚ö†Ô∏è Note: If GPU version fails due to CUDA compatibility, use --force-cpu")
            else:
                paddle_package = "paddlepaddle"
                logger.info("üíª No GPU detected - installing CPU version")
        
        # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á packages
        packages = [paddle_package, "paddleocr"]
        
        # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á PaddleOCR dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        additional_deps = [
            "scikit-image",
            "opencv-python", 
            "Pillow",
            "numpy",
            "matplotlib",
            "pyyaml",
            "lmdb", 
            "imgaug",
            "albumentations",
            "rapidfuzz"
        ]
        
        all_packages = packages + additional_deps
        
        for package in all_packages:
            logger.info(f"Installing {package}...")
            result = subprocess.run([sys.executable, "-m", "pip", "install", package], 
                                  capture_output=True, text=True)
            if result.returncode != 0:
                logger.error(f"Failed to install {package}")
                logger.error(f"Error: {result.stderr}")
                
                # ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á GPU version ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á CPU version ‡πÅ‡∏ó‡∏ô
                if package == "paddlepaddle-gpu":
                    logger.info("üîÑ GPU installation failed, trying CPU version...")
                    result = subprocess.run([sys.executable, "-m", "pip", "install", "paddlepaddle"], 
                                          capture_output=True, text=True)
                    if result.returncode != 0:
                        logger.error(f"CPU installation also failed: {result.stderr}")
                        return False
                    else:
                        logger.info("‚úÖ CPU version installed successfully")
                else:
                    # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dependencies ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ warning ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î
                    if package in additional_deps:
                        logger.warning(f"‚ö†Ô∏è Failed to install {package}, continuing...")
                        continue
                    else:
                        return False
            else:
                logger.info(f"‚úÖ {package} installed successfully")
        
        # Clone PaddleOCR repository
        if not self.paddleocr_dir.exists():
            logger.info("Cloning PaddleOCR repository...")
            result = subprocess.run([
                "git", "clone", 
                "https://github.com/PaddlePaddle/PaddleOCR.git",
                str(self.paddleocr_dir)
            ], capture_output=True, text=True)
            
            if result.returncode != 0:
                logger.error(f"Failed to clone PaddleOCR: {result.stderr}")
                return False
        
        logger.info("‚úÖ PaddleOCR setup completed!")
        return True
    
    def run_training(self, config_type: str = "dev", use_gpu: Optional[bool] = None) -> bool:
        """‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô"""
        logger.info(f"üöÄ Starting local training with {config_type} config...")
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å config file
        config_files = {
            "dev": "thai_rec_dev.yml",
            "main": "thai_rec.yml", 
            "prod": "thai_rec_prod.yml"
        }
        
        if config_type not in config_files:
            logger.error(f"Invalid config type: {config_type}. Choose from: {list(config_files.keys())}")
            return False
        
        config_path = self.configs_dir / config_files[config_type]
        if not config_path.exists():
            logger.error(f"Config file not found: {config_path}")
            return False
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ó‡∏£‡∏ô
        logger.info(f"üìã Config file: {config_path}")
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
        logger.info(f"üéØ Will run training from PaddleOCR directory with relative config path")
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á output directory
        output_dir = self.project_root / "output" / f"{config_type}_training"
        output_dir.mkdir(parents=True, exist_ok=True)
        
        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô
        logger.info("üéØ Starting training process...")
        logger.info("üìä Monitor training progress in the logs below:")
        logger.info("="*60)
        
        try:
            # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô working directory ‡πÄ‡∏õ‡πá‡∏ô PaddleOCR
            original_cwd = os.getcwd()
            os.chdir(str(self.paddleocr_dir))
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ relative path ‡∏à‡∏≤‡∏Å PaddleOCR directory
            relative_config_path = os.path.relpath(str(config_path), str(self.paddleocr_dir))
            
            cmd = [
                sys.executable,
                "tools/train.py",
                "-c", relative_config_path
            ]
            
            # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GPU
            if use_gpu is False:
                cmd.extend(["-o", "Global.use_gpu=false"])
            elif use_gpu is True:
                cmd.extend(["-o", "Global.use_gpu=true"])
            
            logger.info(f"üìã Training command (from PaddleOCR directory):")
            logger.info(f"  {' '.join(cmd)}")
            
            start_time = time.time()
            
            # ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô
            process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                universal_newlines=True,
                bufsize=1
            )
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• log ‡πÅ‡∏ö‡∏ö real-time
            for line in process.stdout:
                print(line, end='')
                sys.stdout.flush()
            
            process.wait()
            
            # ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ original directory
            os.chdir(original_cwd)
            
            duration = time.time() - start_time
            
            if process.returncode == 0:
                logger.info("="*60)
                logger.info(f"üéâ Training completed successfully!")
                logger.info(f"‚è±Ô∏è Duration: {duration/60:.1f} minutes")
                logger.info(f"üìÅ Model saved in PaddleOCR/output/")
                return True
            else:
                logger.error("="*60)
                logger.error(f"‚ùå Training failed with return code: {process.returncode}")
                return False
                
        except Exception as e:
            os.chdir(original_cwd)
            logger.error(f"‚ùå Training error: {e}")
            return False
    
    def generate_training_report(self, config_type: str, success: bool) -> None:
        """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô"""
        status = "COMPLETED" if success else "FAILED"
        report_content = f"""# Task 4.1: Local Training - Report

**Status**: {status} ‚úÖ 
**Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## üöÄ Training Configuration
- **Config Type**: {config_type}
- **Config File**: `configs/rec/thai_rec_{config_type}.yml`
- **Framework**: PaddleOCR
- **Model**: SVTR_LCNet (Thai Recognition)

## üìä Training Details
- **Dataset**: 7,014 train + 1,754 val images
- **Characters**: 880 Thai characters
- **Train/Val Split**: 80/20

## üìÅ Output Locations
- **Model**: `PaddleOCR/output/thai_rec_{config_type}_output/`
- **Logs**: Console output above
- **Config**: `configs/rec/thai_rec_{config_type}.yml`

## üéØ Next Steps
{self._get_next_steps(success)}

---
*Generated by scripts/training/run_local_training.py - Task 4.1*
"""
        
        report_path = self.project_root / f"TASK4_LOCAL_TRAINING_{config_type.upper()}_REPORT.md"
        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(report_content)
        
        logger.info(f"üìã Training report saved: {report_path}")
    
    def _get_next_steps(self, success: bool) -> str:
        if success:
            return """1. **Test model inference** with trained weights
2. **Evaluate model performance** on validation set  
3. **Proceed to SageMaker training** if needed
4. **Update development-task.md** - mark Local training as completed"""
        else:
            return """1. **Check training logs** for error details
2. **Verify dataset and config** files
3. **Try with different config** (dev/main/prod)
4. **Check GPU/CPU availability** and memory"""

def main():
    """Main function"""
    import argparse
    
    parser = argparse.ArgumentParser(description="üöÄ Run Local Training for Thai OCR")
    parser.add_argument("--config", type=str, default="dev", 
                       choices=["dev", "main", "prod"],
                       help="Config type to use (default: dev)")
    parser.add_argument("--setup", action="store_true",
                       help="Setup PaddleOCR before training")
    parser.add_argument("--force-cpu", action="store_true",
                       help="Force CPU version installation (for CUDA compatibility issues)")
    parser.add_argument("--gpu", type=str, default=None,
                       choices=["true", "false"],
                       help="Force GPU usage (true/false)")
    parser.add_argument("--check-only", action="store_true",
                       help="Only check prerequisites, don't train")
    
    args = parser.parse_args()
    
    logger.info("üöÄ Task 4.1: Local Training Setup")
    logger.info("="*50)
    
    runner = LocalTrainingRunner()
    
    # Setup PaddleOCR if requested
    if args.setup:
        if not runner.setup_paddleocr(force_cpu=args.force_cpu):
            logger.error("‚ùå PaddleOCR setup failed")
            return
    
    # Check prerequisites
    if not runner.check_prerequisites():
        logger.error("‚ùå Prerequisites check failed")
        if not args.setup:
            logger.info("üí° Try running with --setup to install requirements")
        return
    
    if args.check_only:
        logger.info("‚úÖ Prerequisites check completed!")
        return
    
    # Convert GPU argument
    use_gpu = None
    if args.gpu == "true":
        use_gpu = True
    elif args.gpu == "false":
        use_gpu = False
    
    # Run training
    success = runner.run_training(args.config, use_gpu)
    
    # Generate report
    runner.generate_training_report(args.config, success)
    
    if success:
        logger.info("üéâ Task 4.1: Local Training - COMPLETED!")
    else:
        logger.error("‚ùå Task 4.1: Local Training - FAILED!")

if __name__ == "__main__":
    main()
